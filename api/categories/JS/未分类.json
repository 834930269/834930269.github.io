{"name":"未分类","slug":"JS/未分类","count":1,"postlist":[{"title":"javascript表单传送文件","slug":"javascrip-form-file","date":"2017-09-10T12:40:21.000Z","updated":"2019-07-03T13:51:36.852Z","comments":true,"path":"api/articles/javascrip-form-file.json","excerpt":"","keywords":null,"cover":null,"content":"<p>专门把这次课给搞出来记一下笔记.. 在HTML中,唯一可以上传文件的就是</p>\n<pre><code>&lt;input type=&quot;file&quot;&gt;</code></pre><p>注意，当一个表单包含file时,表单的<em>enctype_必须是_multipart/form-data</em>,<em>method_必须指定为_post</em>,浏览器才能以正确编码并以_multipart/form-data_格式发送表单. Tip: enctype 属性规定在发送到服务器之前应该如何对表单数据进行编码。 出于安全考虑，浏览器只允许用户点击<code>&lt;input type=&quot;file&quot;&gt;</code>来选择本地文件，用JavaScript对<code>&lt;input type=&quot;file&quot;&gt;</code>的value赋值是没有任何效果的。当用户选择了上传某个文件后，JavaScript也无法获得该文件的真实路径：</p>\n<pre><code>获取表单上传路径后结果总会是fakepath\n&lt;script&gt;\n$(function () {\n    var\n        fileInput = document.getElementById(&apos;test-file-upload&apos;),\n        filePath = document.getElementById(&apos;test-get-filename&apos;);\n    fileInput.addEventListener(&apos;change&apos;, function () {\n        filePath.innerText = fileInput.value;\n    });\n});\n&lt;/script&gt;\n\n&lt;form method=&quot;post&quot; action=&quot;http://localhost/test&quot; enctype=&quot;multipart/form-data&quot;&gt;\n    &lt;p&gt;\n        &lt;input type=&quot;file&quot; id=&quot;test-file-upload&quot; name=&quot;test&quot;&gt;\n    &lt;/p&gt;\n    &lt;p&gt;待上传文件: &lt;span id=&quot;test-get-filename&quot; style=&quot;color:red&quot;&gt;&lt;/span&gt;&lt;/p&gt;\n&lt;/form&gt;</code></pre><p>通常，上传的文件都由后台服务器处理，JavaScript可以在提交表单时对文件扩展名做检查，以便防止用户上传无效格式的文件：</p>\n<pre><code>var f = document.getElementById(&apos;test-file-upload&apos;);\nvar filename = f.value; // &apos;C:\\fakepath\\test.png&apos;\nif (!filename || !(filename.endsWith(&apos;.jpg&apos;) || filename.endsWith(&apos;.png&apos;) || filename.endsWith(&apos;.gif&apos;))) {\n    alert(&apos;Can only upload image file.&apos;);\n    return false;\n}</code></pre><h2 id=\"File-API\"><a href=\"#File-API\" class=\"headerlink\" title=\"File API\"></a>File API</h2><p>由于JavaScript对用户上传的文件操作非常有限，尤其是无法读取文件内容，使得很多需要操作文件的网页不得不用Flash这样的第三方插件来实现。 随着HTML5的普及，新增的File API允许JavaScript读取文件内容，获得更多的文件信息。 HTML5的File API提供了File和FileReader两个主要对象，可以获得文件信息并读取文件。 下面的例子演示了如何读取用户选取的图片文件，并在一个 &lt; div&gt;中预览图像：</p>\n<pre><code>var\n    fileInput = document.getElementById(&apos;test-image-file&apos;),\n    info = document.getElementById(&apos;test-file-info&apos;),\n    preview = document.getElementById(&apos;test-image-preview&apos;);\n// 监听change事件:\nfileInput.addEventListener(&apos;change&apos;, function () {\n    // 清除背景图片:\n    preview.style.backgroundImage = &apos;&apos;;\n    // 检查文件是否选择:\n    if (!fileInput.value) {\n        info.innerHTML = &apos;没有选择文件&apos;;\n        return;\n    }\n    // 获取File引用:\n    var file = fileInput.files[0];\n    // 获取File信息:\n    info.innerHTML = &apos;文件: &apos; + file.name + &apos;&lt;br&gt;&apos; +\n                     &apos;大小: &apos; + file.size + &apos;&lt;br&gt;&apos; +\n                     &apos;修改: &apos; + file.lastModifiedDate;\n    if (file.type !== &apos;image/jpeg&apos; &amp;&amp; file.type !== &apos;image/png&apos; &amp;&amp; file.type !== &apos;image/gif&apos;) {\n        alert(&apos;不是有效的图片文件!&apos;);\n        return;\n    }\n    // 读取文件:\n    var reader = new FileReader();\n    reader.onload = function(e) {\n        var\n            data = e.target.result; // &apos;data:image/jpeg;base64,/9j/4AAQSk...(base64编码)...&apos;            \n        preview.style.backgroundImage = &apos;url(&apos; + data + &apos;)&apos;;\n    };\n    // 以DataURL的形式读取文件:\n    reader.readAsDataURL(file);\n});</code></pre><p>上面的代码演示了如何通过HTML5的File API读取文件内容。以DataURL的形式读取到的文件是一个字符串，类似于data:image/jpeg;base64,/9j/4AAQSk…(base64编码)…，常用于设置图像。如果需要服务器端处理，把字符串base64,后面的字符发送给服务器并用Base64解码就可以得到原始文件的二进制内容。</p>\n<h2 id=\"回调\"><a href=\"#回调\" class=\"headerlink\" title=\"回调\"></a>回调</h2><p>上面的代码还演示了JavaScript的一个重要的特性就是单线程执行模式。在JavaScript中，浏览器的JavaScript执行引擎在执行JavaScript代码时，总是以单线程模式执行，也就是说，任何时候，JavaScript代码都不可能同时有多于1个线程在执行。 你可能会问，单线程模式执行的JavaScript，如何处理多任务？ 在JavaScript中，执行多任务实际上都是异步调用，比如上面的代码： reader.readAsDataURL(file); 就会发起一个异步操作来读取文件内容。因为是异步操作，所以我们在JavaScript代码中就不知道什么时候操作结束，因此需要先设置一个回调函数： reader.onload = function(e) { // 当文件读取完成后，自动调用此函数: }; 当文件读取完成后，JavaScript引擎将自动调用我们设置的回调函数。执行回调函数时，文件已经读取完毕，所以我们可以在回调函数内部安全地获得文件内容。</p>\n","text":"专门把这次课给搞出来记一下笔记.. 在HTML中,唯一可以上传文件的就是&lt;input type=&quot;file&quot;&gt;注意，当一个表单包含file时,表单的enctype_必须是_multipart/form-data,method_必须指定为_post,","link":"","raw":null,"photos":[],"categories":[{"name":"JS","slug":"JS","count":3,"path":"api/categories/JS.json"},{"name":"未分类","slug":"JS/未分类","count":1,"path":"api/categories/JS/未分类.json"}],"tags":[{"name":"JS","slug":"JS","count":5,"path":"api/tags/JS.json"}]}]}